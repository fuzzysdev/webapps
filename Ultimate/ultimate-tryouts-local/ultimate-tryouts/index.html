<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Tryouts">
<title>Ultimate Tryouts</title>
<link rel="manifest" href="/manifest.json">
<link rel="apple-touch-icon" href="/icons/icon-192.png">
<meta name="theme-color" content="#0f1117">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700;800&family=Barlow:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0f1117;
    --surface: #181c26;
    --surface2: #1f2435;
    --border: #2a2f42;
    --accent: #00e5a0;
    --accent-dim: rgba(0,229,160,0.12);
    --cut: #ff4d6d;
    --cut-dim: rgba(255,77,109,0.12);
    --male: #4d9fff;
    --female: #ff80c8;
    --text: #e8eaf0;
    --text-muted: #7a8099;
    --divider: #f5a623;
    --bubble: #a78bfa;
    --bubble-dim: rgba(167,139,250,0.1);
    --card-keep: rgba(0,229,160,0.04);
    --card-bubble: rgba(167,139,250,0.06);
    --card-cut: rgba(255,77,109,0.04);
    --radius: 10px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  body { background: var(--bg); color: var(--text); font-family: 'Barlow', sans-serif; min-height: 100vh; overflow-x: hidden; }

  /* PRIVACY BLUR */
  body.blurred .blur-target { filter: blur(8px); pointer-events: none; user-select: none; }

  /* HEADER */
  header {
    background: var(--surface); border-bottom: 1px solid var(--border);
    padding: 12px 16px; display: flex; align-items: center; justify-content: space-between;
    position: sticky; top: 0; z-index: 100; gap: 10px;
  }
  header h1 { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 800; letter-spacing: 1px; color: var(--accent); text-transform: uppercase; white-space: nowrap; }
  header h1 span { color: var(--text-muted); font-weight: 400; }
  .header-right { display: flex; align-items: center; gap: 8px; }

  /* PRIVACY BUTTON */
  .btn-privacy {
    background: var(--surface2); border: 1px solid var(--border);
    color: var(--text-muted); font-size: 18px; padding: 6px 10px;
    border-radius: 8px; cursor: pointer; transition: all 0.15s; line-height: 1;
  }
  .btn-privacy:hover { border-color: var(--divider); color: var(--divider); }
  body.blurred .btn-privacy { background: var(--divider); border-color: var(--divider); color: #0f1117; }

  /* NAV TABS */
  .tabs { display: flex; gap: 4px; }
  .tab-btn {
    background: none; border: 1px solid var(--border); color: var(--text-muted);
    font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700; letter-spacing: 0.5px;
    padding: 6px 12px; border-radius: 6px; cursor: pointer; text-transform: uppercase; transition: all 0.15s;
  }
  .tab-btn.active { background: var(--accent); border-color: var(--accent); color: #0f1117; }

  /* PAGES */
  .page { display: none; padding: 20px; max-width: 900px; margin: 0 auto; }
  .page.active { display: block; }

  .section-title {
    font-family: 'Barlow Condensed', sans-serif; font-size: 13px; font-weight: 700;
    letter-spacing: 2px; text-transform: uppercase; color: var(--text-muted); margin-bottom: 14px;
  }

  /* ADD PLAYER FORM */
  .add-form { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; margin-bottom: 24px; }
  .add-form h2 { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 16px; }
  .form-row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
  .form-group { display: flex; flex-direction: column; gap: 6px; flex: 1; min-width: 120px; }
  .form-group label { font-size: 11px; font-weight: 600; letter-spacing: 1px; text-transform: uppercase; color: var(--text-muted); }
  .form-group input, .form-group select {
    background: var(--bg); border: 1px solid var(--border); color: var(--text);
    font-family: 'Barlow', sans-serif; font-size: 15px; padding: 10px 12px; border-radius: 7px; outline: none; transition: border-color 0.15s;
  }
  .form-group input:focus, .form-group select:focus { border-color: var(--accent); }
  .form-group select option { background: var(--surface); }
  .btn-add {
    background: var(--accent); color: #0f1117; border: none;
    font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 800; letter-spacing: 0.5px;
    padding: 10px 24px; border-radius: 7px; cursor: pointer; text-transform: uppercase; white-space: nowrap; transition: opacity 0.15s; align-self: flex-end;
  }
  .btn-add:active { opacity: 0.8; }

  /* PLAYERS TABLE */
  .players-table { width: 100%; border-collapse: collapse; }
  .players-table th { font-family: 'Barlow Condensed', sans-serif; font-size: 12px; font-weight: 700; letter-spacing: 1.5px; text-transform: uppercase; color: var(--text-muted); text-align: left; padding: 8px 12px; border-bottom: 1px solid var(--border); }
  .players-table td { padding: 10px 12px; border-bottom: 1px solid var(--border); font-size: 14px; }
  .players-table tr:hover td { background: var(--surface2); }
  .gender-badge { display: inline-block; font-size: 11px; font-weight: 700; padding: 2px 8px; border-radius: 20px; letter-spacing: 0.5px; }
  .gender-badge.M { background: rgba(77,159,255,0.15); color: var(--male); }
  .gender-badge.F { background: rgba(255,128,200,0.15); color: var(--female); }
  .btn-icon { background: none; border: none; cursor: pointer; color: var(--text-muted); padding: 4px 6px; border-radius: 5px; transition: all 0.15s; font-size: 16px; }
  .btn-icon:hover { color: var(--cut); background: var(--cut-dim); }
  .btn-icon.edit:hover { color: var(--accent); background: var(--accent-dim); }
  .empty-state { text-align: center; padding: 48px 20px; color: var(--text-muted); }
  .empty-state .icon { font-size: 48px; margin-bottom: 12px; }
  .empty-state p { font-size: 14px; }

  /* RANKINGS */
  .rankings-layout { display: flex; gap: 16px; }
  .gender-column { flex: 1; min-width: 0; }
  .col-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 2px solid; }
  .col-header.male { border-color: var(--male); }
  .col-header.female { border-color: var(--female); }
  .col-header h3 { font-family: 'Barlow Condensed', sans-serif; font-size: 16px; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
  .col-header.male h3 { color: var(--male); }
  .col-header.female h3 { color: var(--female); }
  .roster-count { font-size: 12px; color: var(--text-muted); font-weight: 600; }
  .rank-list { list-style: none; min-height: 60px; }

  /* DRAG HANDLE */
  .drag-handle { display: flex; flex-direction: column; gap: 3px; padding: 4px 6px; cursor: grab; flex-shrink: 0; touch-action: none; }
  .drag-handle span { display: block; width: 16px; height: 2px; background: var(--border); border-radius: 2px; transition: background 0.15s; }
  .player-card:hover .drag-handle span { background: var(--text-muted); }

  /* PLAYER CARD */
  .player-card {
    display: flex; align-items: center; gap: 8px;
    background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius);
    padding: 10px 10px; margin-bottom: 6px; user-select: none;
    transition: box-shadow 0.15s, border-color 0.15s, background 0.15s; position: relative;
  }
  .player-card.keep   { background: var(--card-keep);   border-color: rgba(0,229,160,0.2); }
  .player-card.bubble { background: var(--card-bubble); border-color: rgba(167,139,250,0.2); }
  .player-card.cut    { background: var(--card-cut);    border-color: rgba(255,77,109,0.2); }
  .player-card.dragging  { opacity: 0.35; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
  .player-card.drag-over { border-color: var(--accent); box-shadow: 0 0 0 2px rgba(0,229,160,0.4); }

  .card-info { flex: 1; min-width: 0; }
  .card-name { font-weight: 600; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .card-meta { font-size: 11px; color: var(--text-muted); margin-top: 2px; }

  .card-actions { display: flex; gap: 2px; align-items: center; }
  .move-btn {
    background: none; border: 1px solid transparent; cursor: pointer; color: var(--text-muted);
    padding: 5px 7px; border-radius: 6px; font-size: 13px; line-height: 1; transition: all 0.12s;
  }
  .move-btn:hover  { color: var(--text); background: var(--surface2); border-color: var(--border); }
  .move-btn:active { transform: scale(0.88); }
  .notes-btn {
    background: none; border: 1px solid transparent; cursor: pointer; padding: 5px 7px;
    border-radius: 6px; font-size: 15px; transition: all 0.12s; color: var(--text-muted);
  }
  .notes-btn:hover    { color: var(--accent); background: var(--accent-dim); border-color: rgba(0,229,160,0.2); }
  .notes-btn.has-notes { color: var(--accent); }

  /* CUT DIVIDER */
  .cut-divider {
    display: flex; align-items: center; gap: 8px;
    margin: 4px 0; padding: 5px 0;
    cursor: ns-resize; touch-action: none; position: relative;
  }
  .cut-divider-line { flex: 1; height: 2px; background: var(--divider); border-radius: 2px; }
  .cut-divider-pill {
    display: flex; align-items: center; gap: 5px;
    font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700;
    letter-spacing: 1.5px; text-transform: uppercase; color: var(--divider);
    white-space: nowrap; padding: 4px 10px; border: 1px solid var(--divider);
    border-radius: 20px; background: rgba(245,166,35,0.08); cursor: ns-resize;
  }
  .cut-divider-arrows { display: flex; flex-direction: column; gap: 0; }
  .cut-arrow {
    background: none; border: none; cursor: pointer; color: var(--divider);
    font-size: 10px; line-height: 1; padding: 1px 2px; transition: all 0.1s;
  }
  .cut-arrow:hover  { color: #fff; transform: scale(1.3); }
  .cut-arrow:active { transform: scale(0.9); }
  .cut-divider.drag-highlight .cut-divider-line { background: #fff; }
  .cut-divider.drag-highlight .cut-divider-pill { background: rgba(245,166,35,0.25); border-color: #fff; color: #fff; }

  /* BUBBLE DIVIDER */
  .bubble-divider {
    display: flex; align-items: center; gap: 8px;
    margin: 4px 0; padding: 5px 0;
    cursor: ns-resize; touch-action: none; position: relative;
  }
  .bubble-divider-line { flex: 1; height: 2px; background: var(--bubble); border-radius: 2px; }
  .bubble-divider-pill {
    display: flex; align-items: center; gap: 5px;
    font-family: 'Barlow Condensed', sans-serif; font-size: 11px; font-weight: 700;
    letter-spacing: 1.5px; text-transform: uppercase; color: var(--bubble);
    white-space: nowrap; padding: 4px 10px; border: 1px solid var(--bubble);
    border-radius: 20px; background: rgba(167,139,250,0.08); cursor: ns-resize;
  }
  .bubble-divider-arrows { display: flex; flex-direction: column; gap: 0; }
  .bubble-arrow {
    background: none; border: none; cursor: pointer; color: var(--bubble);
    font-size: 10px; line-height: 1; padding: 1px 2px; transition: all 0.1s;
  }
  .bubble-arrow:hover  { color: #fff; transform: scale(1.3); }
  .bubble-arrow:active { transform: scale(0.9); }
  .bubble-divider.drag-highlight .bubble-divider-line { background: #fff; }
  .bubble-divider.drag-highlight .bubble-divider-pill { background: rgba(167,139,250,0.25); border-color: #fff; color: #fff; }

  /* NOTES MODAL */
  .modal-overlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 500;
    display: flex; align-items: flex-end; justify-content: center;
    opacity: 0; pointer-events: none; transition: opacity 0.2s;
  }
  .modal-overlay.open { opacity: 1; pointer-events: all; }
  .modal {
    background: var(--surface); border: 1px solid var(--border); border-radius: 16px 16px 0 0;
    width: 100%; max-width: 600px; padding: 24px 20px 36px;
    transform: translateY(100%); transition: transform 0.25s cubic-bezier(.4,0,.2,1);
  }
  .modal-overlay.open .modal { transform: translateY(0); }
  .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; }
  .modal-title  { font-family: 'Barlow Condensed', sans-serif; font-size: 20px; font-weight: 800; }
  .modal-close  { background: var(--surface2); border: none; color: var(--text-muted); font-size: 18px; padding: 6px 10px; border-radius: 7px; cursor: pointer; }
  .notes-textarea {
    width: 100%; background: var(--bg); border: 1px solid var(--border); color: var(--text);
    font-family: 'Barlow', sans-serif; font-size: 15px; line-height: 1.6;
    padding: 12px; border-radius: 8px; resize: none; min-height: 180px; outline: none; transition: border-color 0.15s;
  }
  .notes-textarea:focus { border-color: var(--accent); }
  .modal-save {
    background: var(--accent); color: #0f1117; border: none;
    font-family: 'Barlow Condensed', sans-serif; font-size: 15px; font-weight: 800;
    padding: 12px 28px; border-radius: 8px; cursor: pointer; text-transform: uppercase; margin-top: 14px; width: 100%;
  }

  /* EXPORT */
  .export-section { margin-bottom: 28px; }
  .export-section h2 { font-family: 'Barlow Condensed', sans-serif; font-size: 18px; font-weight: 700; margin-bottom: 14px; }
  .export-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 18px; }
  .export-text {
    background: var(--bg); border: 1px solid var(--border); border-radius: 7px;
    padding: 14px; font-family: monospace; font-size: 13px; color: var(--text);
    white-space: pre; overflow-x: auto; margin-bottom: 12px; max-height: 280px; overflow-y: auto; line-height: 1.6;
  }
  .btn-export {
    background: var(--surface2); border: 1px solid var(--border); color: var(--text);
    font-family: 'Barlow Condensed', sans-serif; font-size: 14px; font-weight: 700;
    padding: 10px 20px; border-radius: 7px; cursor: pointer; text-transform: uppercase;
    letter-spacing: 0.5px; margin-right: 8px; margin-bottom: 8px; transition: all 0.15s;
  }
  .btn-export:hover { border-color: var(--accent); color: var(--accent); }
  .btn-export.primary { background: var(--accent); color: #0f1117; border-color: var(--accent); }

  /* TOAST */
  .toast {
    position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%) translateY(80px);
    background: var(--accent); color: #0f1117; font-family: 'Barlow Condensed', sans-serif;
    font-size: 14px; font-weight: 700; padding: 10px 22px; border-radius: 30px;
    z-index: 1000; transition: transform 0.25s; pointer-events: none; white-space: nowrap;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  @media (max-width: 600px) {
    .rankings-layout { flex-direction: column; }
    .form-row { flex-direction: column; }
    header { padding: 10px 12px; }
    .page { padding: 12px; }
    header h1 { font-size: 17px; }
  }
</style>
</head>
<body>

<header>
  <h1>Ultimate <span>Tryouts</span></h1>
  <div class="header-right">
    <button class="btn-privacy" id="blur-btn" onclick="toggleBlur()" title="Toggle privacy blur">üëÅ</button>
    <div class="tabs">
      <button class="tab-btn active" onclick="showPage('players',this)">Players</button>
      <button class="tab-btn" onclick="showPage('rankings',this)">Rankings</button>
      <button class="tab-btn" onclick="showPage('export',this)">Export</button>
    </div>
  </div>
</header>

<!-- PLAYERS PAGE -->
<div id="page-players" class="page active blur-target">
  <div class="add-form">
    <h2>Add Player</h2>
    <div class="form-row">
      <div class="form-group" style="flex:2">
        <label>Name</label>
        <input type="text" id="inp-name" placeholder="Full name" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Gender</label>
        <select id="inp-gender">
          <option value="M">Male</option>
          <option value="F">Female</option>
        </select>
      </div>
      <div class="form-group">
        <label>Grade</label>
        <select id="inp-grade">
          <option value="6">6th</option><option value="7">7th</option><option value="8">8th</option>
          <option value="9">9th</option><option value="10">10th</option>
          <option value="11">11th</option><option value="12">12th</option>
        </select>
      </div>
      <button class="btn-add" onclick="addPlayer()">+ Add</button>
    </div>
  </div>
  <div class="section-title">All Players (<span id="player-count">0</span>)</div>
  <div id="players-list-wrap">
    <div class="empty-state"><div class="icon">ü•è</div><p>No players yet. Add your first player above.</p></div>
  </div>
</div>

<!-- RANKINGS PAGE -->
<div id="page-rankings" class="page blur-target">
  <div style="display:flex;align-items:center;margin-bottom:16px;">
    <div class="section-title" style="margin:0">Drag cards to rank ¬∑ ‚ñ≤‚ñº to nudge ¬∑ Drag or click ‚ñ≤‚ñº on ‚úÇ to move cut line</div>
  </div>
  <div class="rankings-layout">
    <div class="gender-column">
      <div class="col-header male">
        <h3>‚ôÇ Male</h3>
        <span class="roster-count" id="male-keep-count">0 kept</span>
      </div>
      <ul class="rank-list" id="rank-male" data-gender="M"></ul>
    </div>
    <div class="gender-column">
      <div class="col-header female">
        <h3>‚ôÄ Female</h3>
        <span class="roster-count" id="female-keep-count">0 kept</span>
      </div>
      <ul class="rank-list" id="rank-female" data-gender="F"></ul>
    </div>
  </div>
</div>

<!-- EXPORT PAGE -->
<div id="page-export" class="page blur-target">
  <div class="export-section">
    <h2>Final Roster</h2>
    <div class="export-box">
      <div class="export-text" id="export-roster"></div>
      <button class="btn-export primary" onclick="copyText('export-roster')">üìã Copy</button>
      <button class="btn-export" onclick="downloadCSV('roster')">‚¨á CSV</button>
    </div>
  </div>
  <div class="export-section">
    <h2>Full Rankings (All Players)</h2>
    <div class="export-box">
      <div class="export-text" id="export-full"></div>
      <button class="btn-export primary" onclick="copyText('export-full')">üìã Copy</button>
      <button class="btn-export" onclick="downloadCSV('full')">‚¨á CSV</button>
    </div>
  </div>
</div>

<!-- EDIT PLAYER MODAL -->
<div class="modal-overlay" id="edit-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">‚úèÔ∏è Edit Player</div>
      <button class="modal-close" onclick="closeEdit()">‚úï</button>
    </div>
    <div class="form-row" style="margin-bottom:14px">
      <div class="form-group" style="flex:2">
        <label>Name</label>
        <input type="text" id="edit-name" placeholder="Full name" autocomplete="off">
      </div>
      <div class="form-group">
        <label>Gender</label>
        <select id="edit-gender">
          <option value="M">Male</option>
          <option value="F">Female</option>
        </select>
      </div>
      <div class="form-group">
        <label>Grade</label>
        <select id="edit-grade">
          <option value="6">6th</option><option value="7">7th</option><option value="8">8th</option>
          <option value="9">9th</option><option value="10">10th</option>
          <option value="11">11th</option><option value="12">12th</option>
        </select>
      </div>
    </div>
    <button class="modal-save" onclick="saveEdit()">Save Changes</button>
  </div>
</div>

<!-- NOTES MODAL -->
<div class="modal-overlay" id="notes-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-player-name">Player Notes</div>
      <button class="modal-close" onclick="closeNotes()">‚úï</button>
    </div>
    <textarea class="notes-textarea" id="notes-textarea" placeholder="Add notes about this player..."></textarea>
    <button class="modal-save" onclick="saveNotes()">Save Notes</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
let players     = JSON.parse(localStorage.getItem('ut_players')  || '[]');
let rankings    = JSON.parse(localStorage.getItem('ut_rankings') || 'null') || { M: [], F: [] };
let cutIndex    = JSON.parse(localStorage.getItem('ut_cut')      || 'null') || { M: 3, F: 3 };
let bubbleIndex = JSON.parse(localStorage.getItem('ut_bubble')   || 'null') || { M: 2, F: 2 };
let notes       = JSON.parse(localStorage.getItem('ut_notes')    || '{}');
let isBlurred   = false;
let activeNotesId   = null;
let activeEditId    = null;
let dragSrc = null, dragGender = null;

function save() {
  localStorage.setItem('ut_players',  JSON.stringify(players));
  localStorage.setItem('ut_rankings', JSON.stringify(rankings));
  localStorage.setItem('ut_cut',      JSON.stringify(cutIndex));
  localStorage.setItem('ut_bubble',   JSON.stringify(bubbleIndex));
  localStorage.setItem('ut_notes',    JSON.stringify(notes));
}

// ---- BLUR ----
function toggleBlur() {
  isBlurred = !isBlurred;
  document.body.classList.toggle('blurred', isBlurred);
  const btn = document.getElementById('blur-btn');
  btn.textContent = isBlurred ? 'üôà' : 'üëÅ';
  btn.title = isBlurred ? 'Tap to reveal' : 'Hide from view';
}

// ---- PAGES ----
function showPage(name, btn) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('page-' + name).classList.add('active');
  if (btn) btn.classList.add('active');
  if (name === 'rankings') renderRankings();
  if (name === 'export')   renderExport();
  if (name === 'players')  renderPlayersList();
}

// ---- PLAYERS ----
function addPlayer() {
  const name   = document.getElementById('inp-name').value.trim();
  const gender = document.getElementById('inp-gender').value;
  const grade  = document.getElementById('inp-grade').value;
  if (!name) { showToast('Enter a player name'); return; }
  const id = 'p' + Date.now();
  players.push({ id, name, gender, grade });
  rankings[gender].push(id);
  save();
  document.getElementById('inp-name').value = '';
  renderPlayersList();
  showToast(name + ' added!');
}

function removePlayer(id) {
  const p = players.find(x => x.id === id);
  if (!confirm('Remove ' + p.name + '?')) return;
  players    = players.filter(x => x.id !== id);
  rankings.M = rankings.M.filter(x => x !== id);
  rankings.F = rankings.F.filter(x => x !== id);
  delete notes[id];
  save(); renderPlayersList();
  showToast('Player removed');
}

// ---- EDIT PLAYER ----
function openEdit(id) {
  activeEditId = id;
  const p = players.find(x => x.id === id);
  document.getElementById('edit-name').value   = p.name;
  document.getElementById('edit-gender').value = p.gender;
  document.getElementById('edit-grade').value  = p.grade;
  document.getElementById('edit-modal').classList.add('open');
}
function closeEdit() {
  document.getElementById('edit-modal').classList.remove('open');
  activeEditId = null;
}
function saveEdit() {
  if (!activeEditId) return;
  const name   = document.getElementById('edit-name').value.trim();
  const gender = document.getElementById('edit-gender').value;
  const grade  = document.getElementById('edit-grade').value;
  if (!name) { showToast('Enter a player name'); return; }
  const p = players.find(x => x.id === activeEditId);
  const oldGender = p.gender;
  p.name   = name;
  p.grade  = grade;
  // If gender changed, move in rankings
  if (gender !== oldGender) {
    rankings[oldGender] = rankings[oldGender].filter(x => x !== activeEditId);
    rankings[gender].push(activeEditId);
    p.gender = gender;
  }
  save(); closeEdit(); renderPlayersList();
  if (document.getElementById('page-rankings').classList.contains('active')) renderRankings();
  showToast('Player updated!');
}
document.getElementById('edit-modal').addEventListener('click', function(e) { if (e.target===this) closeEdit(); });

function renderPlayersList() {
  const wrap = document.getElementById('players-list-wrap');
  document.getElementById('player-count').textContent = players.length;
  if (!players.length) {
    wrap.innerHTML = `<div class="empty-state"><div class="icon">ü•è</div><p>No players yet. Add your first player above.</p></div>`;
    return;
  }
  const sorted = [...players].sort((a,b) => a.name.localeCompare(b.name));
  wrap.innerHTML = `<table class="players-table">
    <thead><tr><th>Name</th><th>Gender</th><th>Grade</th><th></th></tr></thead>
    <tbody>${sorted.map(p => `
    <tr>
      <td style="font-weight:600">${p.name}</td>
      <td><span class="gender-badge ${p.gender}">${p.gender==='M'?'Male':'Female'}</span></td>
      <td>Grade ${p.grade}</td>
      <td style="text-align:right">
        <button class="btn-icon edit" onclick="openEdit('${p.id}')" title="Edit player">‚úèÔ∏è</button>
        <button class="btn-icon edit" onclick="openNotes('${p.id}')">${notes[p.id]?'üìù':'üóíÔ∏è'}</button>
        <button class="btn-icon" onclick="removePlayer('${p.id}')">‚úï</button>
      </td>
    </tr>`).join('')}
    </tbody></table>`;
}

// ---- RANKINGS ----
function syncRankings() {
  ['M','F'].forEach(g => {
    const gIds = players.filter(p => p.gender === g).map(p => p.id);
    rankings[g] = rankings[g].filter(id => gIds.includes(id));
    gIds.forEach(id => { if (!rankings[g].includes(id)) rankings[g].push(id); });
    // Clamp bubble/cut indices
    bubbleIndex[g] = Math.min(bubbleIndex[g], rankings[g].length);
    cutIndex[g]    = Math.min(Math.max(cutIndex[g], bubbleIndex[g]), rankings[g].length);
  });
}

function renderRankings() { syncRankings(); renderColumn('M'); renderColumn('F'); save(); }

function getZone(i, gender) {
  const b = bubbleIndex[gender], c = cutIndex[gender];
  if (i < b) return 'keep';
  if (i < c) return 'bubble';
  return 'cut';
}

function renderColumn(gender) {
  const listEl = document.getElementById('rank-' + (gender==='M'?'male':'female'));
  const ids    = rankings[gender];
  const bubAt  = Math.min(bubbleIndex[gender], ids.length);
  const cutAt  = Math.min(cutIndex[gender], ids.length);
  listEl.innerHTML = '';

  if (bubAt === 0 && ids.length > 0) listEl.appendChild(makeBubbleDivider(gender));
  if (cutAt === 0 && ids.length > 0 && bubAt !== 0) listEl.appendChild(makeDivider(gender));
  if (cutAt === 0 && bubAt === 0 && ids.length > 0) listEl.appendChild(makeDivider(gender));

  ids.forEach((id, i) => {
    const p = players.find(x => x.id === id);
    if (!p) return;
    const zone    = getZone(i, gender);
    const hasNote = notes[id] && notes[id].trim();

    const li = document.createElement('li');
    li.className = 'player-card ' + zone;
    li.setAttribute('draggable', 'true');
    li.dataset.id = id; li.dataset.gender = gender; li.dataset.index = i;

    let zoneLabel = '';
    if (zone === 'keep')   zoneLabel = '<span style="color:var(--accent)">‚úì Keep</span>';
    if (zone === 'bubble') zoneLabel = '<span style="color:var(--bubble)">‚óà Bubble</span>';
    if (zone === 'cut')    zoneLabel = '<span style="color:var(--cut)">‚úó Cut</span>';

    li.innerHTML = `
      <div class="drag-handle" title="Drag to reorder"><span></span><span></span><span></span></div>
      <div class="card-info">
        <div class="card-name">${p.name}</div>
        <div class="card-meta">Grade ${p.grade} ¬∑ ${zoneLabel}</div>
      </div>
      <div class="card-actions">
        <button class="move-btn" onclick="moveCard('${gender}',${i},-1)" title="Move up">‚ñ≤</button>
        <button class="move-btn" onclick="moveCard('${gender}',${i},1)"  title="Move down">‚ñº</button>
        <button class="notes-btn ${hasNote?'has-notes':''}" onclick="openNotes('${id}')">${hasNote?'üìù':'üóíÔ∏è'}</button>
      </div>`;

    // Desktop drag events
    li.addEventListener('dragstart', onDragStart);
    li.addEventListener('dragover',  onDragOver);
    li.addEventListener('drop',      onDrop);
    li.addEventListener('dragend',   onDragEnd);

    // Touch drag events on the handle
    const handle = li.querySelector('.drag-handle');
    handle.addEventListener('touchstart', onTouchStart, { passive: false });

    listEl.appendChild(li);

    if (i === bubAt - 1) listEl.appendChild(makeBubbleDivider(gender));
    if (i === cutAt - 1 && cutAt !== bubAt) listEl.appendChild(makeDivider(gender));
    // If bubble and cut are at same position, show both
    if (i === bubAt - 1 && cutAt === bubAt) {
      listEl.appendChild(makeDivider(gender));
    }
  });

  document.getElementById(gender==='M'?'male-keep-count':'female-keep-count').textContent =
    bubAt + ' kept ¬∑ ' + (cutAt - bubAt) + ' bubble';
}

function makeDivider(gender) {
  const li = document.createElement('li');
  li.className = 'cut-divider';
  li.dataset.isDivider = 'true';
  li.dataset.gender = gender;

  li.innerHTML = `
    <div class="cut-divider-line"></div>
    <div class="cut-divider-pill">
      <div class="cut-divider-arrows">
        <button class="cut-arrow" title="Move cut line up">‚ñ≤</button>
        <button class="cut-arrow" title="Move cut line down">‚ñº</button>
      </div>
      ‚úÇ Cut Line
    </div>
    <div class="cut-divider-line"></div>`;

  const [upBtn, downBtn] = li.querySelectorAll('.cut-arrow');
  upBtn.addEventListener('click',   e => { e.stopPropagation(); moveCut(gender, -1); });
  downBtn.addEventListener('click', e => { e.stopPropagation(); moveCut(gender, 1); });

  let startY = 0, startCut = 0;
  li.addEventListener('touchstart', e => {
    if (e.target.closest('.cut-arrow')) return;
    startY = e.touches[0].clientY; startCut = cutIndex[gender];
    li.classList.add('drag-highlight'); e.preventDefault();
  }, { passive: false });
  li.addEventListener('touchmove', e => {
    const delta = Math.round((e.touches[0].clientY - startY) / 54);
    const newCut = Math.max(bubbleIndex[gender], Math.min(rankings[gender].length, startCut + delta));
    if (newCut !== cutIndex[gender]) { cutIndex[gender] = newCut; save(); renderColumn(gender); }
    e.preventDefault();
  }, { passive: false });
  li.addEventListener('touchend', () => li.classList.remove('drag-highlight'));

  li.addEventListener('dragover', e => { e.preventDefault(); li.classList.add('drag-highlight'); });
  li.addEventListener('dragleave', () => li.classList.remove('drag-highlight'));
  li.addEventListener('drop', e => {
    e.preventDefault(); li.classList.remove('drag-highlight');
    if (!dragSrc) return;
    const g = dragSrc.dataset.gender, fromIdx = parseInt(dragSrc.dataset.index);
    const [moved] = rankings[g].splice(fromIdx, 1);
    rankings[g].splice(Math.max(bubbleIndex[g], fromIdx < cutIndex[g] ? cutIndex[g] - 1 : cutIndex[g]), 0, moved);
    save(); renderColumn(g);
  });
  return li;
}

function makeBubbleDivider(gender) {
  const li = document.createElement('li');
  li.className = 'bubble-divider';
  li.dataset.isBubble = 'true';
  li.dataset.gender = gender;

  li.innerHTML = `
    <div class="bubble-divider-line"></div>
    <div class="bubble-divider-pill">
      <div class="bubble-divider-arrows">
        <button class="bubble-arrow" title="Move bubble line up">‚ñ≤</button>
        <button class="bubble-arrow" title="Move bubble line down">‚ñº</button>
      </div>
      ü´ß Bubble
    </div>
    <div class="bubble-divider-line"></div>`;

  const [upBtn, downBtn] = li.querySelectorAll('.bubble-arrow');
  upBtn.addEventListener('click',   e => { e.stopPropagation(); moveBubble(gender, -1); });
  downBtn.addEventListener('click', e => { e.stopPropagation(); moveBubble(gender, 1); });

  let startY = 0, startBubble = 0;
  li.addEventListener('touchstart', e => {
    if (e.target.closest('.bubble-arrow')) return;
    startY = e.touches[0].clientY; startBubble = bubbleIndex[gender];
    li.classList.add('drag-highlight'); e.preventDefault();
  }, { passive: false });
  li.addEventListener('touchmove', e => {
    const delta = Math.round((e.touches[0].clientY - startY) / 54);
    const newB = Math.max(0, Math.min(cutIndex[gender], startBubble + delta));
    if (newB !== bubbleIndex[gender]) { bubbleIndex[gender] = newB; save(); renderColumn(gender); }
    e.preventDefault();
  }, { passive: false });
  li.addEventListener('touchend', () => li.classList.remove('drag-highlight'));

  li.addEventListener('dragover', e => { e.preventDefault(); li.classList.add('drag-highlight'); });
  li.addEventListener('dragleave', () => li.classList.remove('drag-highlight'));
  li.addEventListener('drop', e => {
    e.preventDefault(); li.classList.remove('drag-highlight');
    if (!dragSrc) return;
    const g = dragSrc.dataset.gender, fromIdx = parseInt(dragSrc.dataset.index);
    const [moved] = rankings[g].splice(fromIdx, 1);
    rankings[g].splice(Math.max(0, fromIdx < bubbleIndex[g] ? bubbleIndex[g] - 1 : bubbleIndex[g]), 0, moved);
    save(); renderColumn(g);
  });
  return li;
}

function moveCut(gender, dir) {
  cutIndex[gender] = Math.max(bubbleIndex[gender], Math.min(rankings[gender].length, cutIndex[gender] + dir));
  save(); renderColumn(gender);
}

function moveBubble(gender, dir) {
  bubbleIndex[gender] = Math.max(0, Math.min(cutIndex[gender], bubbleIndex[gender] + dir));
  save(); renderColumn(gender);
}

function moveCard(gender, index, dir) {
  const list = rankings[gender];
  const ni   = index + dir;
  if (ni < 0 || ni >= list.length) return;
  [list[index], list[ni]] = [list[ni], list[index]];
  save(); renderColumn(gender);
}

// ---- TOUCH DRAG FOR PLAYER CARDS ----
let touchDragId = null, touchDragGender = null, touchDragStartY = 0, touchDragStartIndex = 0;
let touchDragEl = null, touchGhost = null;

function onTouchStart(e) {
  const card = e.currentTarget.closest('.player-card');
  if (!card) return;
  e.preventDefault();
  touchDragId     = card.dataset.id;
  touchDragGender = card.dataset.gender;
  touchDragStartIndex = parseInt(card.dataset.index);
  touchDragStartY = e.touches[0].clientY;
  touchDragEl = card;
  card.style.opacity = '0.4';

  document.addEventListener('touchmove',  onTouchMove,  { passive: false });
  document.addEventListener('touchend',   onTouchEnd,   { passive: false });
}

function onTouchMove(e) {
  e.preventDefault();
  if (!touchDragEl) return;
  const ty = e.touches[0].clientY;
  const listEl = document.getElementById('rank-' + (touchDragGender==='M'?'male':'female'));
  const cards = [...listEl.querySelectorAll('.player-card')];
  // Find which card we're hovering over
  cards.forEach(c => c.classList.remove('drag-over'));
  for (const c of cards) {
    const rect = c.getBoundingClientRect();
    if (ty >= rect.top && ty <= rect.bottom && c !== touchDragEl) {
      c.classList.add('drag-over');
      break;
    }
  }
}

function onTouchEnd(e) {
  document.removeEventListener('touchmove', onTouchMove);
  document.removeEventListener('touchend',  onTouchEnd);
  if (!touchDragEl) return;

  touchDragEl.style.opacity = '';
  const ty = e.changedTouches[0].clientY;
  const listEl = document.getElementById('rank-' + (touchDragGender==='M'?'male':'female'));
  const cards = [...listEl.querySelectorAll('.player-card')];
  cards.forEach(c => c.classList.remove('drag-over'));

  let targetIndex = null;
  for (const c of cards) {
    const rect = c.getBoundingClientRect();
    if (ty >= rect.top && ty <= rect.bottom && c !== touchDragEl) {
      targetIndex = parseInt(c.dataset.index);
      break;
    }
  }

  if (targetIndex !== null && targetIndex !== touchDragStartIndex) {
    const g = touchDragGender;
    const [moved] = rankings[g].splice(touchDragStartIndex, 1);
    rankings[g].splice(targetIndex, 0, moved);
    save(); renderColumn(g);
  }

  touchDragId = null; touchDragGender = null; touchDragEl = null;
}

// ---- DESKTOP DRAG ----
function onDragStart(e) {
  dragSrc = e.currentTarget; dragGender = dragSrc.dataset.gender;
  setTimeout(() => dragSrc.classList.add('dragging'), 0);
  e.dataTransfer.effectAllowed = 'move';
}
function onDragEnd() {
  document.querySelectorAll('.player-card').forEach(c => c.classList.remove('dragging','drag-over'));
  dragSrc = null;
}
function onDragOver(e) {
  e.preventDefault();
  if (!dragSrc) return;
  const t = e.currentTarget;
  if (t === dragSrc || t.dataset.gender !== dragGender) return;
  document.querySelectorAll('.player-card').forEach(c => c.classList.remove('drag-over'));
  t.classList.add('drag-over');
}
function onDrop(e) {
  e.preventDefault();
  if (!dragSrc) return;
  const t = e.currentTarget;
  if (t === dragSrc || t.dataset.gender !== dragGender) return;
  const g = dragGender;
  const from = parseInt(dragSrc.dataset.index), to = parseInt(t.dataset.index);
  const [moved] = rankings[g].splice(from, 1);
  rankings[g].splice(to, 0, moved);
  save(); renderColumn(g);
}

// ---- NOTES ----
function openNotes(id) {
  activeNotesId = id;
  const p = players.find(x => x.id === id);
  document.getElementById('modal-player-name').textContent = 'üìù ' + p.name;
  document.getElementById('notes-textarea').value = notes[id] || '';
  document.getElementById('notes-modal').classList.add('open');
}
function closeNotes() { document.getElementById('notes-modal').classList.remove('open'); activeNotesId = null; }
function saveNotes() {
  if (!activeNotesId) return;
  notes[activeNotesId] = document.getElementById('notes-textarea').value;
  save(); closeNotes(); renderPlayersList();
  if (document.getElementById('page-rankings').classList.contains('active')) renderRankings();
  showToast('Notes saved');
}
document.getElementById('notes-modal').addEventListener('click', function(e) { if (e.target===this) closeNotes(); });

// ---- EXPORT ----
function renderExport() {
  syncRankings();
  const rosterLines = ['FINAL ROSTER','====================',''];
  const fullLines   = ['FULL TRYOUT RANKINGS','====================',''];
  const rosterCSV   = [['Rank','Name','Gender','Grade','Status','Notes']];
  const fullCSV     = [['Rank','Name','Gender','Grade','Status','Notes']];
  ['M','F'].forEach(g => {
    const label = g==='M'?'MALE':'FEMALE';
    const bub = bubbleIndex[g], cut = cutIndex[g];
    rosterLines.push('--- '+label+' ---'); fullLines.push('--- '+label+' ---');
    rankings[g].forEach((id, i) => {
      const p = players.find(x => x.id===id); if (!p) return;
      const zone   = getZone(i, g);
      const status = zone === 'keep' ? 'KEEP' : zone === 'bubble' ? 'BUBBLE' : 'CUT';
      const note   = notes[id]?notes[id].replace(/\n/g,' '):'';
      const rank   = i+1;
      const line   = `${String(rank).padStart(2,'0')}. ${p.name} (Gr.${p.grade}) [${status}]`;
      if (zone !== 'cut') rosterLines.push(line);
      fullLines.push(line+(note?' | '+note:''));
      if (zone !== 'cut') rosterCSV.push([rank,p.name,g==='M'?'Male':'Female',p.grade,status,note]);
      fullCSV.push([rank,p.name,g==='M'?'Male':'Female',p.grade,status,note]);
    });
    rosterLines.push(''); fullLines.push('');
  });
  document.getElementById('export-roster').textContent = rosterLines.join('\n');
  document.getElementById('export-full').textContent   = fullLines.join('\n');
  window._rosterCSV = rosterCSV; window._fullCSV = fullCSV;
}

function copyText(id) {
  const text = document.getElementById(id).textContent;
  navigator.clipboard.writeText(text).then(()=>showToast('Copied!')).catch(()=>{
    const ta=document.createElement('textarea'); ta.value=text;
    document.body.appendChild(ta); ta.select(); document.execCommand('copy');
    document.body.removeChild(ta); showToast('Copied!');
  });
}
function downloadCSV(type) {
  const data = type==='roster'?window._rosterCSV:window._fullCSV;
  const csv  = data.map(r=>r.map(v=>'"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
  const a    = Object.assign(document.createElement('a'),{href:URL.createObjectURL(new Blob([csv],{type:'text/csv'})),download:(type==='roster'?'roster':'full-rankings')+'.csv'});
  a.click(); showToast('CSV downloaded!');
}

function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'), 2200);
}

renderPlayersList();

// ---- SERVICE WORKER ----
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(reg => console.log('SW registered:', reg.scope))
      .catch(err => console.warn('SW registration failed:', err));
  });
}
</script>
</body>
</html>
